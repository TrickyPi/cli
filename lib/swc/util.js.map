{"version":3,"sources":["../../src/swc/util.ts"],"sourcesContent":["import * as swc from \"@swc/core\";\nimport slash from \"slash\";\nimport { mkdirSync, writeFileSync, readFileSync, statSync } from \"fs\";\nimport { dirname, relative, resolve } from \"path\";\n\nexport async function transform(\n  filename: string,\n  code: string,\n  opts: swc.Options,\n  sync: boolean,\n  outputPath: string | undefined\n): Promise<swc.Output> {\n  opts = {\n    filename,\n    ...opts,\n  };\n\n  if (outputPath) {\n    opts.outputPath = outputPath;\n  }\n\n  if (sync) {\n    return swc.transformSync(code, opts);\n  }\n\n  return swc.transform(code, opts);\n}\n\nexport async function compile(\n  filename: string,\n  opts: swc.Options,\n  sync: boolean,\n  outputPath: string | undefined\n): Promise<swc.Output | void> {\n  opts = {\n    ...opts,\n  };\n  if (outputPath) {\n    opts.outputPath = outputPath;\n  }\n\n  try {\n    const result = sync\n      ? swc.transformFileSync(filename, opts)\n      : await swc.transformFile(filename, opts);\n\n    if (result.map) {\n      // TODO: fix this in core\n      // https://github.com/swc-project/swc/issues/1388\n      const sourceMap = JSON.parse(result.map);\n      if (opts.sourceFileName) {\n        sourceMap[\"sources\"][0] = opts.sourceFileName;\n      }\n      if (opts.sourceRoot) {\n        sourceMap[\"sourceRoot\"] = opts.sourceRoot;\n      }\n      result.map = JSON.stringify(sourceMap);\n    }\n    return result;\n  } catch (err) {\n    if (!err.message.includes(\"ignored by .swcrc\")) {\n      throw err;\n    }\n  }\n}\n\nexport function outputFile(\n  output: swc.Output,\n  filename: string,\n  sourceMaps: undefined | swc.Options[\"sourceMaps\"]\n) {\n  const destDir = dirname(filename);\n  mkdirSync(destDir, { recursive: true });\n\n  let code = output.code;\n  if (output.map && sourceMaps !== \"inline\") {\n    // we've requested for a sourcemap to be written to disk\n    const fileDirName = dirname(filename);\n    const mapLoc = filename + \".map\";\n    code += \"\\n//# sourceMappingURL=\" + slash(relative(fileDirName, mapLoc));\n    writeFileSync(mapLoc, output.map);\n  }\n\n  writeFileSync(filename, code);\n}\n\nexport function assertCompilationResult<T>(\n  result: Map<string, Error | T>,\n  quiet = false\n): asserts result is Map<string, T> {\n  let compiled = 0;\n  let copied = 0;\n  let failed = 0;\n  for (const value of result.values()) {\n    if (value instanceof Error) {\n      failed++;\n    } else if ((value as unknown) === \"copied\") {\n      copied++;\n    } else if (value) {\n      compiled++;\n    }\n  }\n  if (!quiet && compiled + copied > 0) {\n    const copyResult = copied === 0 ? \" \" : ` (copied ${copied}) `;\n    console.info(\n      `Successfully compiled ${compiled} ${\n        compiled !== 1 ? \"files\" : \"file\"\n      }${copyResult}with swc.`\n    );\n  }\n\n  if (failed > 0) {\n    throw new Error(\n      `Failed to compile ${failed} ${failed !== 1 ? \"files\" : \"file\"} with swc.`\n    );\n  }\n}\n\nexport function getSwcrcInfo(): false | swc.Options {\n  const fileLocation = resolve(process.cwd(), \".swcrc\");\n  if (!statSync(fileLocation)) return false;\n  try {\n    const info = readFileSync(fileLocation, \"utf-8\");\n    const json = JSON.parse(info);\n    return json;\n  } catch (err) {\n    throw new Error(`Failed to parse .swcrc use JSON.parse`);\n  }\n}\n"],"names":["transform","compile","outputFile","assertCompilationResult","getSwcrcInfo","swc","filename","code","opts","sync","outputPath","transformSync","result","transformFileSync","transformFile","map","sourceMap","JSON","parse","sourceFileName","sourceRoot","stringify","err","message","includes","output","sourceMaps","destDir","recursive","fileDirName","mapLoc","quiet","compiled","copied","failed","value","values","Error","copyResult","console","info","fileLocation","process","cwd","json"],"mappings":"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"}